shp_to_sf_rds <- function(x){
# select file
# x <- all_shapes[all_shapes %like% 2020][3]
# x <- all_shapes[1]
# get corresponding year of the file
years <- lapply(strsplit(x, "/"), head, n = 2L)
years <- unlist(lapply(years, tail, n = 1L))
years <-  unlist(regmatches(years, gregexpr("[[:digit:]]+", years)))
years <- unique(years)
# Encoding for different years
if (years %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
}
if (years %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
}
if (years %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 15 digits of a string
if( years %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( years %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( years %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes") {
dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", years)
}
# name of the file that will be saved
# if( years %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg") }
# if( years %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg") }
# if( years %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg") }
# if( years %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg") }
# if( years %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t <- strsplit(x, "/")
t <- t[[1]][length(t[[1]])]
n <- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0(dest_dir,"/BR250GC_SIR.gpkg"), overwrite = TRUE)
}
all_shapes
shp_to_sf_rds[1]
all_shapes
all_shapes[1]
all_shapes[1:2]
lapply(X=all_shapes[1:2], FUN=shp_to_sf_rds)
dest_dir
shp_to_sf_rds <- function(x){
# get corresponding year of the file
#x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir <- paste0(sub_dirs,"/",substr(dest_dir,11,15))
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0("shapes_in_sf_all_years_original/",dest_dir,"BR250GC_SIR.gpkg"), overwrite = TRUE)
}
lapply(X=all_shapes[1:5], FUN=shp_to_sf_rds)
shp_to_sf_rds <- function(x){
# get corresponding year of the file
#x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir <- paste0(sub_dirs,"/",substr(dest_dir,11,15))
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0("shapes_in_sf_all_years_original/",dest_dir,"BR250GC_SIR.gpkg"), overwrite = TRUE)
}
paste0("shapes_in_sf_all_years_original/",dest_dir,"BR250GC_SIR.gpkg")
dest_dir
shp_to_sf_rds <- function(x){
# get corresponding year of the file
#x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir <- paste0(sub_dirs,"/",substr(dest_dir,11,15))
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0("shapes_in_sf_all_years_original/",dest_dir,"/BR250GC_SIR.gpkg"), overwrite = TRUE)
}
all_shapes[1:5]
lapply(X=all_shapes[1:5], FUN=shp_to_sf_rds)
shp_to_sf_rds <- function(x){
# get corresponding year of the file
#x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir <- paste0(sub_dirs,"/",substr(dest_dir,11,15))
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0("./shapes_in_sf_all_years_original/",dest_dir,"/BR250GC_SIR.gpkg"), overwrite = TRUE)
}
lapply(X=all_shapes[1:5], FUN=shp_to_sf_rds)
shp_to_sf_rds <- function(x){
# get corresponding year of the file
#x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir <- paste0(sub_dirs,"/",substr(dest_dir,11,15))
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0(dest_dir,"/BR250GC_SIR.gpkg"), overwrite = TRUE)
}
lapply(X=all_shapes[1:5], FUN=shp_to_sf_rds)
lapply(X=all_shapes[1:2], FUN=shp_to_sf_rds)
# List shapes for all years
all_shapes <- list.files(full.names = T, recursive = T, pattern = ".shp$")
all_shapes <- all_shapes[all_shapes %like% paste0(year)]
all_shapes
region='uf'
if (region == "uf"){all_shapes <- all_shapes[(all_shapes %like% "UFE250|uf500|UF2500|UF500|UF2500|UF_")]}
if (region == "meso_regiao"){all_shapes <- all_shapes[all_shapes %like% "Mesorregioes|mesorregioes|ME500"]}
if (region == "micro_regiao"){all_shapes <- all_shapes[all_shapes %like% "MI|Microrregioes|microrregioes"]}
if (region == "municipio"){all_shapes <- all_shapes[all_shapes %like% "MU|mu500|mu2500|mu1000|Municipios"]}
temp <- NULL
shp_to_sf_rds <- function(x){
# get corresponding year of the file
#x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir <- paste0(sub_dirs,"/",substr(dest_dir,11,15))
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0(dest_dir,"/BR250GC_SIR.gpkg"), overwrite = TRUE)
}
lapply(X=all_shapes[1:2], FUN=shp_to_sf_rds)
all_shapes[1]
x <- all_shapes[1]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
x
year=2000
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
lapply(X=all_shapes[1:2], FUN=shp_to_sf_rds)
sub_dirs <- list.dirs(path =root_dir, recursive = F)
# get all years in the directory
sub_dirs <- sub_dirs[sub_dirs %like% paste0(year)]
# create directory to save original shape files in sf format
dir.create(file.path("shapes_in_sf_all_years_original"), showWarnings = FALSE)
# create a subdirectory of states, municipalities, micro and meso regions
dir.create(file.path("shapes_in_sf_all_years_original/",paste0(region)), showWarnings = FALSE)
# create a subdirectory of years
sub_dirs <- paste0("./shapes_in_sf_all_years_original/",region)
dir.create(file.path(sub_dirs,year), showWarnings = FALSE)
gc(reset = T)
sub_dirs
lapply(X=all_shapes[1:2], FUN=shp_to_sf_rds)
x <- all_shapes[1]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
file_name
paste0(sub_dirs,"/",substr(dest_dir,11,15))
last15
dest_dir
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
dest_dir
file_name
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
n
substr(x, 3, nchar(x)-(n+1) )
t
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
dest_dir
shp_to_sf_rds <- function(x){
# get corresponding year of the file
# x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0(dest_dir,"/BR250GC_SIR.gpkg"), overwrite = TRUE)
}
lapply(X=all_shapes[1:2], FUN=shp_to_sf_rds)
dest_dir
lapply(X=all_shapes[1:7], FUN=shp_to_sf_rds)
shp_to_sf_rds <- function(x){
# get corresponding year of the file
# x <- all_shapes[1]
# select file
# x <- all_shapes[all_shapes %like% 2000][3]
# Encoding for different years
if (year %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
} else if (year %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
} else if (year %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 4 digits of a string
if( year %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( year %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( year %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes"){ dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", year)}
# name of the file that will be saved
# if( year %like% "2000|2001|2010|2013|2014"){ file_name <- paste0(toupper(substr(x, 21, 24)), ".gpkg")
# } else if( year %like% "2005"){ file_name <- paste0( toupper(substr(x, 67, 70)), ".gpkg")
# } else if( year %like% "2007"){ file_name <- paste0( toupper(substr(x, 66, 69)), ".gpkg")
# } else if( year %like% "2015|2016|2017|2018"){ file_name <- paste0( toupper(substr(x, 25, 28)), ".gpkg")
# } else if( year %like% "2019"){ file_name <- paste0( toupper(substr(x, 25, 29)), ".gpkg") }
# name of the file and directory that will be saved
t<-strsplit(x, "/")
t<-t[[1]][length(t[[1]])]
n<- nchar(t)
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
temp <- rbind(temp,shape_i) %>% st_as_sf()
# save in .rds
sf::st_write(temp, dsn = paste0(dest_dir,"/", file_name), overwrite = TRUE)
}
lapply(X=all_shapes[1:7], FUN=shp_to_sf_rds)
sub_dirs <- list.dirs(path = root_dir, recursive = F)
sub_dirs <- sub_dirs[! (sub_dirs %like% "_all_years_original")]
message(paste0("saving gpkg\n"))
sub_dirs <- list.dirs(path = root_dir, recursive = F)
# Root directory
root_dir <- "L:/# DIRUR #/ASMEQ/geobr/data-raw/malhas_municipais"
setwd(root_dir)
message(paste0("saving gpkg\n"))
sub_dirs <- list.dirs(path = root_dir, recursive = F)
sub_dirs <- sub_dirs[! (sub_dirs %like% "_all_years_original")]
sub_dirs <- sub_dirs[! (sub_dirs %like% "_all_years_clean")]
year='all'
region='uf'
# get all years in the directory
years <- unlist(lapply(strsplit(sub_dirs, "/"), tail, n = 1L))
years <-  unlist(regmatches(years, gregexpr("[[:digit:]]+", years)))
years <- unique(years)
years
# create directory to save original shape files in sf format
dir.create(file.path("shapes_in_sf_all_years_original"), showWarnings = FALSE)
# create a subdirectory of states, municipalities, micro and meso regions
dir.create(file.path("shapes_in_sf_all_years_original/",paste0(region)), showWarnings = FALSE)
# create a subdirectory of years
sub_dirs_cleaned <- paste0("./shapes_in_sf_all_years_cleaned/",region)
sub_dirs_original <- paste0("./shapes_in_sf_all_years_original/",region)
sub_dirs_original
for (y in years){
dir.create( file.path(sub_dirs_cleaned, y), showWarnings = FALSE)
dir.create( file.path(sub_dirs_original, y), showWarnings = FALSE)
}
gc(reset = T)
# List shapes for all years
all_shapes <- list.files(full.names = T, recursive = T, pattern = ".shp$")
if (region == "uf"){ all_shapes <- all_shapes[(all_shapes %like% "UFE250|uf500|UF2500|UF500|UF2500|UF_")] }
if (region == "meso_regiao"){all_shapes <- all_shapes[all_shapes %like% "Mesorregioes"]}
if (region == "micro_regiao"){all_shapes <- all_shapes[all_shapes %like% "MI|Microrregioes"]}
if (region == "municipio"){all_shapes <- all_shapes[all_shapes %like% "MU|mu500|mu2500|mu1000|Municipios"]}
temp <- NULL
all_shapes
x <- all_shapes[1]
# get corresponding year of the file
years <- lapply(strsplit(x, "/"), head, n = 2L)
years <- unlist(lapply(years, tail, n = 1L))
years <-  unlist(regmatches(years, gregexpr("[[:digit:]]+", years)))
years <- unique(years)
years
# Encoding for different years
if (years %like% "2000"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=IBM437")
}
if (years %like% "2001|2005|2007|2010"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=WINDOWS-1252")
}
if (years %like% "2013|2014|2015|2016|2017|2018|2019|2020"){
shape_i <- st_read(x, quiet = T, stringsAsFactors=F, options = "ENCODING=UTF8")
}
shape_i
# get destination subdirectory based on abbreviation of the geography
last15 <- substr(x, nchar(x)-15, nchar(x)) # function to get the last 15 digits of a string
if( years %like% "2019|2020" & region %like% "Municipio|uf|municipio"){last15 <- substr(x, nchar(x)-18, nchar(x))}
if( years %like% "2019|2020" & region %like% "meso_regiao"){last15 <- substr(x, nchar(x)-20, nchar(x))}
if( years %like% "2019|2020" & region %like% "micro_regiao"){last15 <- substr(x, nchar(x)-21, nchar(x))}
if ( last15 %like% "UF|uf|ME|me|MI|mi|MU|mu|Municipios|Mesorregioes|Microrregioes") {
dest_dir <- paste0("./shapes_in_sf_all_years_original/",region,"/", years)
}
dest_dir
# name of the file and directory that will be saved
t <- strsplit(x, "/")
t <- t[[1]][length(t[[1]])]
n <- nchar(t)
substr(x, 3, nchar(x)-(n+1) )
#dest_dir <- substr(x, 3, nchar(x)-(n+1) )
file_name <- gsub(".shp$", ".gpkg", t, ignore.case = T)
file_name
dest_dir
source("./prep_data/prep_functions.R")
source('./prep_data/download_malhas_municipais_function.R')
setwd('L:/# DIRUR #/ASMEQ/geobr/data-raw')
###### Unzip raw data --------------------------------
unzip_to_geopackage(region='uf',year='all')
setwd('L:/# DIRUR #/ASMEQ/geobr/data-raw')
source("./prep_data/prep_functions.R")
source('./prep_data/download_malhas_municipais_function.R')
